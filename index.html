<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Typing Challenge Online</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
body { font-family: Arial; background:#222; color:#fff; text-align:center; }
#game-container { max-width:600px; margin:20px auto; padding:10px; background:#333; border-radius:10px;}
textarea { width:100%; height:100px; font-size:18px; }
#text-display { font-size:18px; background:#444; padding:10px; border-radius:5px; min-height:100px; margin-bottom:10px; }
#scoreboard { margin-top:10px; background:#444; padding:10px; border-radius:5px; text-align:left; max-height:200px; overflow-y:auto;}
button { padding:10px 20px; font-size:16px; margin:5px; }
.correct { color:lime; }
.incorrect { color:red; }
</style>
</head>
<body>
<h1>Typing Challenge Online</h1>
<div id="game-container">
  <div id="text-display"></div>
  <textarea id="input-text" placeholder="Gõ văn bản ở đây..."></textarea><br>
  <button id="start-btn">Bắt đầu</button>
  <p>Thời gian: <span id="timer">60</span>s | Điểm: <span id="score">0</span> | WPM: <span id="wpm">0</span></p>
  <div id="scoreboard"><b>Bảng xếp hạng:</b><br></div>
</div>

<script>
// Firebase Config
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
  databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT_ID.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Game variables
let textToType = "";
let timer = 60;
let interval;
let started = false;
let score = 0;
let charsTyped = 0;

// Sample texts
const texts = [
  "Block Blast là game xếp hình thú vị và thư giãn.",
  "Gõ nhanh và đúng chính tả để ghi nhiều điểm nhất.",
  "Typing Challenge giúp cải thiện tốc độ gõ bàn phím.",
  "Hãy thử thách bản thân và trở thành người nhanh nhất!"
];

// Elements
const textDisplay = document.getElementById('text-display');
const inputText = document.getElementById('input-text');
const startBtn = document.getElementById('start-btn');
const timerEl = document.getElementById('timer');
const scoreEl = document.getElementById('score');
const wpmEl = document.getElementById('wpm');
const scoreboard = document.getElementById('scoreboard');

// Start game
startBtn.addEventListener('click', ()=>{
  startGame();
});

function startGame(){
  started = true;
  timer = 60;
  score = 0;
  charsTyped = 0;
  timerEl.textContent = timer;
  scoreEl.textContent = score;
  wpmEl.textContent = 0;
  inputText.value = "";
  textToType = texts[Math.floor(Math.random()*texts.length)];
  displayText();
  inputText.focus();
  
  clearInterval(interval);
  interval = setInterval(()=>{
    timer--;
    timerEl.textContent = timer;
    updateScore();
    if(timer<=0){
      endGame();
    }
  },1000);
}

function displayText(){
  let html = "";
  for(let i=0;i<textToType.length;i++){
    html += `<span id="char${i}">${textToType[i]}</span>`;
  }
  textDisplay.innerHTML = html;
}

// Update score
inputText.addEventListener('input',()=>{
  if(!started) return;
  let input = inputText.value;
  charsTyped = 0;
  for(let i=0;i<textToType.length;i++){
    let charSpan = document.getElementById('char'+i);
    if(i<input.length){
      if(input[i]===textToType[i]){
        charSpan.className="correct";
        charsTyped++;
      } else charSpan.className="incorrect";
    } else charSpan.className="";
  }
  score = charsTyped;
  scoreEl.textContent = score;
  wpmEl.textContent = Math.round((charsTyped/5)/(60-timer+1)*60);
});

function updateScore(){
  wpmEl.textContent = Math.round((charsTyped/5)/(60-timer+1)*60);
}

// End game
function endGame(){
  started=false;
  clearInterval(interval);
  alert("Kết thúc! Điểm: "+score+" | WPM: "+wpmEl.textContent);
  let username = prompt("Nhập tên của bạn:");
  if(username){
    let entry = {
      name: username,
      score: score,
      wpm: wpmEl.textContent,
      timestamp: new Date().toISOString()
    };
    db.ref('leaderboard').push(entry);
  }
  inputText.value="";
}

// Realtime leaderboard
db.ref('leaderboard').on('value',(snapshot)=>{
  let data = snapshot.val();
  if(!data) return;
  let arr = Object.values(data);
  arr.sort((a,b)=>b.score-a.score);
  let html = "<b>Bảng xếp hạng:</b><br>";
  arr.forEach((item,i)=>{
    html += `${i+1}. ${item.name} - Điểm: ${item.score} | WPM: ${item.wpm} | ${new Date(item.timestamp).toLocaleString()}<br>`;
  });
  scoreboard.innerHTML = html;
});

</script>
</body>
</html>
